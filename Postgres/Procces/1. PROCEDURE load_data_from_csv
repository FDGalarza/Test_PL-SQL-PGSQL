CREATE OR REPLACE PROCEDURE load_data_from_csv(p_file_path TEXT)
LANGUAGE plpgsql AS
$$
BEGIN
    -- Crear una tabla temporal para cargar los datos del CSV
    CREATE TEMP TABLE temp_data (
        game_id INTEGER,
        title TEXT,
        company_id INTEGER,
        release_year INTEGER,
        price NUMERIC(10,2),
        average_rating NUMERIC(3,2),
        rating_id INTEGER,
        nickname VARCHAR(30),
        score NUMERIC(3,2)
    );

    -- Cargar datos en la tabla temporal
    EXECUTE FORMAT('COPY temp_data FROM %L WITH (FORMAT CSV, HEADER TRUE)', p_file_path);

    -- Insertar en Videogames
    INSERT INTO Videogames (game_id, title, company_id, release_year, price, average_rating)
    SELECT DISTINCT game_id, title, company_id, release_year, price, average_rating
    FROM temp_data
    WHERE game_id IS NOT NULL
    ON CONFLICT (game_id) DO NOTHING; -- Ignorar si ya existe

    -- Insertar en Ratings
    INSERT INTO Ratings (rating_id, nickname, game_id, score)
    SELECT rating_id, nickname, game_id, score
    FROM temp_data
    WHERE rating_id IS NOT NULL 
      AND game_id IS NOT NULL 
      AND game_id IN (SELECT game_id FROM Videogames); -- Asegurar que exista el game_id

    -- Eliminar la tabla temporal
    DROP TABLE temp_data;
END;
$$;